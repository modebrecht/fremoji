<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Franz√∂sisch Master Trainer (Lvl 1-3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&display=swap');

        body { font-family: 'Nunito', sans-serif; background-color: #f0fdf4; }
        h1, h2, h3, .emoji-display { font-family: 'Fredoka', sans-serif; }

        .emoji-bounce { animation: bounce 2s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }

        .btn-option { transition: all 0.2s; }
        .btn-option:active { transform: scale(0.95); }
        .fade-in { animation: fadeIn 0.4s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .correct-anim { background-color: #86efac !important; border-color: #22c55e !important; color: #064e3b !important; }
        .wrong-anim { background-color: #fca5a5 !important; border-color: #ef4444 !important; color: #7f1d1d !important; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .selected-article { background-color: #e0e7ff !important; border-color: #6366f1 !important; }

        .locked { opacity: 0.6; cursor: not-allowed; filter: grayscale(100%); position: relative; }
        .level-badge { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: bold; }
</style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-100 via-indigo-100 to-purple-100">

    <div class="w-full max-w-lg bg-white rounded-3xl shadow-2xl overflow-hidden border-4 border-white min-h-[600px] flex flex-col relative">
        
        <div class="bg-indigo-600 p-4 text-white flex justify-between items-center shadow-md z-10">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üá´üá∑</span>
                <span class="font-bold text-lg leading-tight">Master Trainer<br><span class="text-indigo-200 text-xs font-normal">Wortschatz & Grammatik</span></span>
            </div>
            <div class="flex gap-2">
                <button onclick="goToMenu()" id="home-btn" class="hidden text-xs bg-indigo-700 hover:bg-indigo-800 px-3 py-1 rounded-lg transition">üè† Men√º</button>
            </div>
        </div>

        <div id="menu-screen" class="p-6 fade-in flex-grow flex flex-col">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-700">Themenwahl</h2>
                <button onclick="showHistory()" class="bg-slate-800 text-white py-2 px-4 rounded-xl font-bold hover:bg-slate-700 transition shadow-lg flex items-center gap-2 text-sm">
                    üìÑ Resultate & Export
                </button>
            </div>
            <div class="grid grid-cols-1 gap-4 overflow-y-auto pb-4 flex-1" id="category-grid">
                </div>
        </div>

        <div id="history-screen" class="hidden p-6 fade-in flex-grow flex flex-col h-full bg-gray-50">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Deine Ergebnisse</h2>
                <button onclick="exportToPDF()" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold px-3 py-2 rounded shadow flex items-center gap-1">
                    üíæ PDF
                </button>
            </div>
            
            <div id="history-list" class="flex-grow overflow-y-auto space-y-3 pr-1 pb-4">
                <div class="text-center text-gray-400 mt-10">Noch keine Spiele gespielt.</div>
            </div>

            <div class="mt-4 pt-2 border-t flex gap-2">
                <button onclick="clearHistory()" class="text-xs text-red-400 hover:text-red-600 underline">Verlauf l√∂schen</button>
                <button onclick="goToMenu()" class="ml-auto bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold">Zur√ºck</button>
            </div>
        </div>

        <div id="game-screen" class="hidden flex-grow flex flex-col h-full">
            <div class="w-full bg-gray-200 h-3">
                <div class="bg-green-500 h-3 transition-all duration-500" style="width: 0%" id="progress-bar"></div>
            </div>
            <div class="px-6 pt-3 pb-3 text-center fade-in flex-grow flex flex-col justify-center">
                <div class="flex justify-between items-center mb-2">
                     <span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider" id="topic-level-label">THEMA LVL 1</span>
                     <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider" id="level-label">Frage 1/10</span>
                </div>
                
                <div class="text-[4.727rem] mb-4 mt-2 emoji-display emoji-bounce drop-shadow-md cursor-default select-none" id="emoji-container">ü§î</div>
                
                <div id="word-hint" class="text-2xl font-bold text-gray-600 mb-6 h-8 flex justify-center items-center"></div>

                <div class="grid grid-cols-1 gap-3" id="options-container">
                    </div>
                
            </div>
        </div>

        <div id="result-screen" class="hidden p-6 text-center fade-in flex-grow flex flex-col overflow-y-auto">
            <div class="text-6xl mb-2">üèÅ</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-1">Runde beendet</h2>
            
            <div class="bg-indigo-50 rounded-xl p-4 mb-4 border-2 border-indigo-100 shadow-inner">
                <div class="flex justify-around items-end">
                    <div>
                        <div class="text-xs text-gray-500 uppercase font-bold">Score</div>
                        <div class="text-4xl font-bold text-green-600" id="final-score">0/10</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 uppercase font-bold">Prozent</div>
                        <div class="text-4xl font-bold text-indigo-600" id="final-percent">0%</div>
                    </div>
                </div>
            </div>

            <div id="unlock-msg" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 mb-4 text-left rounded shadow-sm text-sm">
                <span class="font-bold">üîì Neues Level freigeschaltet!</span><br>
                Super gemacht!
            </div>

            <div id="mistakes-container" class="hidden text-left mb-6 flex-grow">
                <h3 class="text-red-500 font-bold mb-2 text-sm border-b pb-1">‚ö†Ô∏è Fehleranalyse:</h3>
                <div class="space-y-2 text-xs" id="mistakes-list"></div>
            </div>
            
            <div id="perfect-msg" class="hidden text-green-600 font-bold text-lg mb-6">Incroyable! Perfekt! üéâ</div>

            <div class="mt-auto space-y-2 pb-20"> <button onclick="goToMenu()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition">
                    Zur√ºck zum Men√º üè†
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const categories = [
            { id: 'essen', title: 'Essen', icon: 'ü•ê', color: 'bg-orange-50 border-orange-200', questions: [
                { emoji: "ü•ê", correct: "le croissant" }, { emoji: "üßÄ", correct: "le fromage" },
                { emoji: "üçü", correct: "les frites" }, { emoji: "üçé", correct: "la pomme" },
                { emoji: "üçû", correct: "le pain" }, { emoji: "üçó", correct: "le poulet" },
                { emoji: "ü•ö", correct: "l'≈ìuf" }, { emoji: "ü•ó", correct: "la salade" },
                { emoji: "üç´", correct: "le chocolat" }, { emoji: "üç¶", correct: "la glace" }
            ]},
            { id: 'trinken', title: 'Getr√§nke', icon: 'ü•§', color: 'bg-blue-50 border-blue-200', questions: [
                { emoji: "üíß", correct: "l'eau" }, { emoji: "‚òï", correct: "le caf√©" },
                { emoji: "ü•õ", correct: "le lait" }, { emoji: "üßÉ", correct: "le jus" },
                { emoji: "üçµ", correct: "le th√©" }, { emoji: "üç∑", correct: "le vin" },
                { emoji: "üç∫", correct: "la bi√®re" }, { emoji: "ü•§", correct: "le soda" },
                { emoji: "üçã", correct: "la limonade" }, { emoji: "üçº", correct: "le biberon" }
            ]},
            { id: 'kleidung', title: 'Kleidung', icon: 'üëó', color: 'bg-pink-50 border-pink-200', questions: [
                { emoji: "üëñ", correct: "le pantalon" }, { emoji: "üëó", correct: "la robe" },
                { emoji: "üëï", correct: "le t-shirt" }, { emoji: "üëü", correct: "les chaussures" },
                { emoji: "üëì", correct: "les lunettes" }, { emoji: "üß•", correct: "le manteau" },
                { emoji: "üß¢", correct: "la casquette" }, { emoji: "üß¶", correct: "les chaussettes" },
                { emoji: "üëî", correct: "la chemise" }, { emoji: "üß£", correct: "l'√©charpe" }
            ]},
            { id: 'tiere', title: 'Tiere', icon: 'üêæ', color: 'bg-green-50 border-green-200', questions: [
                { emoji: "üêï", correct: "le chien" }, { emoji: "üêà", correct: "le chat" },
                { emoji: "üêé", correct: "le cheval" }, { emoji: "üê¶", correct: "l'oiseau" },
                { emoji: "üêü", correct: "le poisson" }, { emoji: "üêÑ", correct: "la vache" },
                { emoji: "üêñ", correct: "le cochon" }, { emoji: "ü¶Å", correct: "le lion" },
                { emoji: "üêò", correct: "l'√©l√©phant" }, { emoji: "üêí", correct: "le singe" }
            ]},
            { id: 'schule', title: 'Schule', icon: 'üè´', color: 'bg-yellow-50 border-yellow-200', questions: [
                { emoji: "üñäÔ∏è", correct: "le stylo" }, { emoji: "üìö", correct: "les livres" },
                { emoji: "üéí", correct: "le sac √† dos" }, { emoji: "üíª", correct: "l'ordinateur" },
                { emoji: "‚úÇÔ∏è", correct: "les ciseaux" }, { emoji: "üìè", correct: "la r√®gle" },
                { emoji: "üìù", correct: "le devoir" }, { emoji: "üè´", correct: "l'√©cole" },
                { emoji: "ü™ë", correct: "la chaise" }, { emoji: "üñçÔ∏è", correct: "le crayon" }
            ]},
            { id: 'transport', title: 'Verkehr', icon: 'üöÜ', color: 'bg-gray-50 border-gray-200', questions: [
                { emoji: "üöó", correct: "la voiture" }, { emoji: "üöÜ", correct: "le train" },
                { emoji: "‚úàÔ∏è", correct: "l'avion" }, { emoji: "üö≤", correct: "le v√©lo" },
                { emoji: "üöå", correct: "le bus" }, { emoji: "üö§", correct: "le bateau" },
                { emoji: "üèçÔ∏è", correct: "la moto" }, { emoji: "üöÅ", correct: "l'h√©licopt√®re" },
                { emoji: "üöá", correct: "le m√©tro" }, { emoji: "üéüÔ∏è", correct: "le billet" }
            ]},
            { id: 'haus', title: 'Haus', icon: 'üè†', color: 'bg-teal-50 border-teal-200', questions: [
                { emoji: "üè†", correct: "la maison" }, { emoji: "üõèÔ∏è", correct: "le lit" },
                { emoji: "üõÅ", correct: "la baignoire" }, { emoji: "üõãÔ∏è", correct: "le canap√©" },
                { emoji: "üì∫", correct: "la t√©l√©" }, { emoji: "üóùÔ∏è", correct: "la cl√©" },
                { emoji: "üö™", correct: "la porte" }, { emoji: "üçΩÔ∏è", correct: "la table" },
                { emoji: "üå≥", correct: "le jardin" }, { emoji: "üöΩ", correct: "les toilettes" }
            ]},
            { id: 'sport', title: 'Sport', icon: '‚öΩ', color: 'bg-red-50 border-red-200', questions: [
                { emoji: "‚öΩ", correct: "le foot" }, { emoji: "üéæ", correct: "le tennis" },
                { emoji: "üèÄ", correct: "le basket" }, { emoji: "üèä", correct: "la natation" },
                { emoji: "üéø", correct: "le ski" }, { emoji: "üèÖ", correct: "la m√©daille" },
                { emoji: "üö¥", correct: "le cyclisme" }, { emoji: "ü•ä", correct: "la boxe" },
                { emoji: "üßò", correct: "le yoga" }, { emoji: "üèÜ", correct: "le champion" }
            ]}
        ];

        // --- STATE & STORAGE ---
        let userProgress = JSON.parse(localStorage.getItem('frQuizProgress')) || {};
        let gameHistory = JSON.parse(localStorage.getItem('frQuizHistory')) || [];

        let currentSet = [];
        let currentIndex = 0;
        let score = 0;
        let wrongAnswers = [];
        let isAnswerLocked = false;
        let selectedArticle = null;
        let activeCategoryIndex = null;
        let activeLevel = 1;

        // --- HELPERS ---
        function saveProgress(catId, level) {
            if (!userProgress[catId]) userProgress[catId] = { l1: false, l2: false, l3: false };
            if (level === 1) userProgress[catId].l1 = true;
            if (level === 2) userProgress[catId].l2 = true;
            if (level === 3) userProgress[catId].l3 = true;
            localStorage.setItem('frQuizProgress', JSON.stringify(userProgress));
        }

        function saveGameResult() {
            const cat = categories[activeCategoryIndex];
            const result = {
                date: new Date().toLocaleString('de-DE'),
                topic: cat.title,
                level: activeLevel,
                score: `${score}/${currentSet.length}`,
                percentage: Math.round((score/currentSet.length)*100),
                mistakes: wrongAnswers // Array of {emoji, correct, selected}
            };
            gameHistory.unshift(result); // Add to top
            if (gameHistory.length > 50) gameHistory.pop(); // Limit to 50
            localStorage.setItem('frQuizHistory', JSON.stringify(gameHistory));
        }

        function clearHistory() {
            if(confirm("Wirklich den gesamten Verlauf l√∂schen?")) {
                gameHistory = [];
                localStorage.setItem('frQuizHistory', JSON.stringify([]));
                showHistory();
            }
        }

        function splitArticleWord(fullString) {
            const articles = ['le', 'la', 'l\'', 'les', 'un', 'une', 'des'];
            let foundArticle = "";
            let noun = fullString;
            for (let art of articles) {
                if (fullString.startsWith(art + " ") || (art === "l'" && fullString.startsWith(art))) {
                    if (art === "l'") { foundArticle = "l'"; noun = fullString.substring(2); }
                    else { foundArticle = art; noun = fullString.substring(art.length).trim(); }
                    break;
                }
            }
            return { article: foundArticle, noun: noun };
        }

        function getWrongGenderArticle(correctArticle) {
            if (correctArticle === 'le') return 'la';
            if (correctArticle === 'la') return 'le';
            if (correctArticle === "l'") return 'la'; // simplification
            if (correctArticle === 'les') return 'des';
            return 'un';
        }

        function normalizeWord(word) {
            return word
                .toLowerCase()
                .trim()
                .replace(/\s+/g, ' ')
                .replace(/‚Äô/g, "'")
                .replace(/≈ì/g, 'oe');
        }

        function normalizeForPdf(text) {
            return String(text)
                .replace(/≈ì/g, 'oe')
                .replace(/≈í/g, 'Oe')
                .replace(/[‚Äô']/g, "'")
                .replace(/√†/g, 'a')
                .replace(/√¢/g, 'a')
                .replace(/√§/g, 'a')
                .replace(/√ß/g, 'c')
                .replace(/√©/g, 'e')
                .replace(/√®/g, 'e')
                .replace(/√™/g, 'e')
                .replace(/√´/g, 'e')
                .replace(/√Æ/g, 'i')
                .replace(/√Ø/g, 'i')
                .replace(/√¥/g, 'o')
                .replace(/√∂/g, 'o')
                .replace(/√π/g, 'u')
                .replace(/√ª/g, 'u')
                .replace(/√º/g, 'u');
        }

        function sanitizePdfText(text) {
            return normalizeForPdf(text)
                .replace(/[^\x20-\x7E]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function getLevel3Articles(article) {
            if (article === "les") return ["des"];
            if (article === "l'") return ["l'"];
            if (article === "le" || article === "la") return [article];
            return [article];
        }

        function getLevel3ArticleOptions(article) {
            if (article === "le" || article === "la" || article === "l'") {
                return ["le", "la", "l'"];
            }
            return ["des", "de la", "du"];
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- UI NAVIGATION ---
        function initMenu() {
            const grid = document.getElementById('category-grid');
            grid.innerHTML = '';

            categories.forEach((cat, index) => {
                const status = userProgress[cat.id] || { l1: false, l2: false, l3: false };
                const isL2Unlocked = status.l1 === true;
                const isL3Unlocked = status.l2 === true;

                const card = document.createElement('div');
                card.className = `p-4 rounded-2xl border shadow-sm flex items-center justify-between ${cat.color}`;

                const l2ButtonClass = isL2Unlocked
                    ? 'bg-yellow-500 hover:bg-yellow-600 text-white shadow-md'
                    : 'bg-gray-300 text-gray-500 locked shadow-none';
                const l2Icon = isL2Unlocked ? '‚ö°' : 'üîí';
                const l2Onclick = isL2Unlocked ? `startGame(${index}, 2)` : '';

                const l3ButtonClass = isL3Unlocked
                    ? 'bg-purple-600 hover:bg-purple-700 text-white shadow-md'
                    : 'bg-gray-300 text-gray-500 locked shadow-none';
                const l3Icon = isL3Unlocked ? 'üëë' : 'üîí';
                const l3Onclick = isL3Unlocked ? `startGame(${index}, 3)` : '';

                card.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">${cat.icon}</div>
                        <div class="font-bold text-gray-800">${cat.title}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="startGame(${index}, 1)" class="flex flex-col items-center justify-center w-16 h-14 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-md transition transform active:scale-95">
                            <span class="text-lg">üìñ</span>
                            <span class="level-badge">Lvl 1</span>
                        </button>
                        <button onclick="${l2Onclick}" class="flex flex-col items-center justify-center w-16 h-14 rounded-xl transition transform active:scale-95 ${l2ButtonClass}">
                            <span class="text-lg">${l2Icon}</span>
                            <span class="level-badge">Lvl 2</span>
                        </button>
                        <button onclick="${l3Onclick}" class="flex flex-col items-center justify-center w-16 h-14 rounded-xl transition transform active:scale-95 ${l3ButtonClass}">
                            <span class="text-lg">${l3Icon}</span>
                            <span class="level-badge">Lvl 3</span>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });

            document.getElementById('menu-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('history-screen').classList.add('hidden');
            document.getElementById('home-btn').classList.add('hidden');
        }

        function showHistory() {
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('history-screen').classList.remove('hidden');
            document.getElementById('home-btn').classList.remove('hidden');

            const list = document.getElementById('history-list');
            list.innerHTML = '';

            if (gameHistory.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 mt-10">Noch keine Spiele gespielt.</div>';
                return;
            }

            gameHistory.forEach((game, idx) => {
                const isPerfect = game.percentage === 100;
                const item = document.createElement('div');
                item.className = 'bg-white p-3 rounded-lg border shadow-sm text-sm';
                
                let mistakesHTML = '';
                if (game.mistakes && game.mistakes.length > 0) {
                    const mistakeTxt = game.mistakes
                        .map(m => `<span class="text-red-500">${m.selected}</span> <span class="text-green-600">${m.correct}</span>`)
                        .join(' | ');
                    mistakesHTML = `<div class="mt-2 text-xs text-red-500 border-t pt-1"><strong>Fehler:</strong> ${mistakeTxt}</div>`;
                }

                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-gray-800">${game.topic} <span class="text-gray-400 font-normal">(${game.date})</span></div>
                            <div class="text-xs text-gray-500 uppercase font-bold mt-1">Level ${game.level}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${isPerfect ? 'text-green-600' : 'text-indigo-600'}">${game.score}</div>
                            <div class="text-xs text-gray-400">${game.percentage}%</div>
                        </div>
                    </div>
                    ${mistakesHTML}
                `;
                list.appendChild(item);
            });
        }

        function goToMenu() {
            initMenu();
        }

        // --- GAME LOGIC ---
        function startGame(catIndex, level) {
            activeCategoryIndex = catIndex;
            activeLevel = level;
            const category = categories[catIndex];
            
            currentSet = shuffleArray([...category.questions]);
            currentIndex = 0;
            score = 0;
            wrongAnswers = [];
            isAnswerLocked = false;

            const lvlNames = { 1: "Wortschatz", 2: "Artikel", 3: "Meister" };

            document.getElementById('topic-level-label').innerText = `${category.title} LVL ${level}`;
            document.getElementById('level-label').innerText = `Frage 1/${currentSet.length}`;
            
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('history-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('home-btn').classList.remove('hidden');
            const scoreEl = document.getElementById('score-display');
            if (scoreEl) scoreEl.innerText = `Punkte: 0`;

            loadQuestion();
        }

        function loadQuestion() {
            if (currentIndex >= currentSet.length) {
                endGame();
                return;
            }

            const q = currentSet[currentIndex];
            const container = document.getElementById('options-container');
            const wordHint = document.getElementById('word-hint');
            container.innerHTML = '';
            
            document.getElementById('emoji-container').innerText = q.emoji;
            document.getElementById('level-label').innerText = `Frage ${currentIndex + 1}/${currentSet.length}`;
            document.getElementById('progress-bar').style.width = `${(currentIndex / currentSet.length) * 100}%`;

            let correctVal = "";
            let options = [];

            // LEVEL LOGIC
            if (activeLevel === 1) {
                // L1: Full word (original mode)
                wordHint.innerText = "";
                correctVal = q.correct;
                // Get other words from same category or random
                const others = currentSet.filter(x => x.correct !== q.correct).map(x => x.correct);
                const randomDistractors = shuffleArray(others).slice(0, 3);
                options = shuffleArray([q.correct, ...randomDistractors]);

            } else if (activeLevel === 2) {
                // L2: Article only
                const parts = splitArticleWord(q.correct);
                correctVal = parts.article;
                wordHint.innerHTML = `<span class="border-b-2 border-gray-400 w-12 inline-block mx-2"></span> ${parts.noun}`;
                
                // Articles options
                options = ["le", "la", "l'", "les"];
                if (!options.includes(correctVal)) {
                     options[3] = correctVal; // replace 'les' if answer is 'une' etc
                }

            } else if (activeLevel === 3) {
                // L3: Pick article + type noun
                wordHint.innerText = "";
                const parts = splitArticleWord(q.correct);
                const correctArticles = getLevel3Articles(parts.article);
                const correctNoun = parts.noun;
                const articleOptions = getLevel3ArticleOptions(parts.article);
                selectedArticle = null;

                const articleGrid = document.createElement('div');
                articleGrid.className = 'grid grid-cols-3 gap-3';
                articleOptions.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-option w-full bg-white border-2 border-indigo-100 text-indigo-900 font-semibold py-3 px-2 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 text-lg shadow-sm';
                    btn.innerText = opt;
                    btn.onclick = () => {
                        if (isAnswerLocked) return;
                        selectedArticle = opt;
                        Array.from(articleGrid.querySelectorAll('button')).forEach(b => {
                            b.classList.toggle('selected-article', b.innerText === opt);
                        });
                    };
                    articleGrid.appendChild(btn);
                });

                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'Nomen eingeben';
                input.className = 'w-full border-2 border-indigo-100 rounded-xl px-3 py-3 text-lg focus:outline-none focus:border-indigo-400';

                const submit = document.createElement('button');
                submit.className = 'btn-option w-full bg-indigo-600 text-white font-semibold py-3 px-2 rounded-xl hover:bg-indigo-700 text-lg shadow-sm';
                submit.innerText = 'Antwort pr√ºfen';
                submit.onclick = () => checkLevel3Answer(articleGrid, input, correctArticles, correctNoun, q);

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        checkLevel3Answer(articleGrid, input, correctArticles, correctNoun, q);
                    }
                });

                container.appendChild(articleGrid);
                container.appendChild(input);
                container.appendChild(submit);
            }

            if (activeLevel !== 3) {
                options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-option w-full bg-white border-2 border-indigo-100 text-indigo-900 font-semibold py-3 px-2 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 text-lg shadow-sm';
                    btn.innerText = opt;
                    btn.onclick = () => checkAnswer(btn, opt, correctVal, q);
                    container.appendChild(btn);
                });
            }

            isAnswerLocked = false;
        }

        function checkAnswer(btn, selected, correctVal, questionObj) {
            if (isAnswerLocked) return;
            isAnswerLocked = true;

            const isCorrect = selected === correctVal;
            const allBtns = document.querySelectorAll('.btn-option');

            if (isCorrect) {
                score++;
                btn.classList.add('correct-anim');
                const scoreEl = document.getElementById('score-display');
                if (scoreEl) scoreEl.innerText = `Punkte: ${score}`;
            } else {
                btn.classList.add('wrong-anim');
                
                // Save specific info for L3/L2 logic display
                let displayError = selected; 
                let displayCorrect = questionObj.correct;

                wrongAnswers.push({
                    emoji: questionObj.emoji,
                    correct: displayCorrect, 
                    selected: displayError
                });
                
                // Highlight correct
                allBtns.forEach(b => {
                    if (b.innerText === correctVal) {
                        b.classList.add('correct-anim');
                    }
                });
            }

            setTimeout(() => {
                currentIndex++;
                loadQuestion();
            }, 1200);
        }

        function checkLevel3Answer(articleGrid, inputEl, correctArticles, correctNoun, questionObj) {
            if (isAnswerLocked) return;
            const typed = normalizeWord(inputEl.value);
            if (!selectedArticle || !typed) {
                inputEl.classList.add('wrong-anim');
                setTimeout(() => inputEl.classList.remove('wrong-anim'), 500);
                return;
            }

            const allArticleBtns = Array.from(articleGrid.querySelectorAll('button'));
            allArticleBtns.forEach(b => b.classList.remove('wrong-anim', 'correct-anim'));
            inputEl.classList.remove('wrong-anim', 'correct-anim');

            isAnswerLocked = true;
            const articleOk = correctArticles.includes(selectedArticle);
            const nounOk = typed === normalizeWord(correctNoun);

            if (articleOk && nounOk) {
                score++;
                const scoreEl = document.getElementById('score-display');
                if (scoreEl) scoreEl.innerText = `Punkte: ${score}`;
                allArticleBtns.forEach(b => {
                    if (correctArticles.includes(b.innerText)) b.classList.add('correct-anim');
                });
                inputEl.classList.add('correct-anim');
                setTimeout(() => {
                    currentIndex++;
                    loadQuestion();
                }, 1200);
            } else {
                allArticleBtns.forEach(b => {
                    if (correctArticles.includes(b.innerText)) b.classList.add('correct-anim');
                });
                if (!articleOk && selectedArticle) {
                    allArticleBtns.forEach(b => {
                        if (b.innerText === selectedArticle) b.classList.add('wrong-anim');
                    });
                }
                if (!nounOk) inputEl.classList.add('wrong-anim');

                wrongAnswers.push({
                    emoji: questionObj.emoji,
                    correct: `${correctArticles[0]} ${correctNoun}`,
                    selected: `${selectedArticle} ${inputEl.value.trim()}`
                });
                setTimeout(() => {
                    allArticleBtns.forEach(b => b.classList.remove('wrong-anim'));
                    inputEl.classList.remove('wrong-anim');
                    isAnswerLocked = false;
                }, 600);
            }
        }

        function endGame() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = `100%`;

            const total = currentSet.length;
            const percent = Math.round((score/total)*100);
            const catId = categories[activeCategoryIndex].id;

            document.getElementById('final-score').innerText = `${score}/${total}`;
            document.getElementById('final-percent').innerText = `${percent}%`;

            // UNLOCK LOGIC (Need 70%)
            const passed = score >= 7;
            const unlockMsg = document.getElementById('unlock-msg');
            unlockMsg.classList.add('hidden');

            if (passed) {
                if (activeLevel === 1 && !userProgress[catId]?.l1) {
                    unlockMsg.classList.remove('hidden');
                    saveProgress(catId, 1);
                } else if (activeLevel === 2 && !userProgress[catId]?.l2) {
                    unlockMsg.classList.remove('hidden');
                    saveProgress(catId, 2);
                } else if (activeLevel === 3) {
                    saveProgress(catId, 3);
                }
            }

            // Save to History
            saveGameResult();

            // Render Mistakes
            const mistakesContainer = document.getElementById('mistakes-container');
            const mistakesList = document.getElementById('mistakes-list');
            const perfectMsg = document.getElementById('perfect-msg');

            if (wrongAnswers.length > 0) {
                perfectMsg.classList.add('hidden');
                mistakesContainer.classList.remove('hidden');
                mistakesList.innerHTML = '';
                
                wrongAnswers.forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'flex items-center justify-between bg-white p-2 rounded border border-gray-200';
                    row.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="text-xl">${item.emoji}</span>
                            <span class="text-xs text-red-400 line-through">${item.selected}</span>
                        </div>
                        <div class="text-green-700 text-xs font-bold">
                            ${item.correct}
                        </div>
                    `;
                    mistakesList.appendChild(row);
                });
            } else {
                mistakesContainer.classList.add('hidden');
                perfectMsg.classList.remove('hidden');
            }
        }

        // --- PDF EXPORT ---
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 14;
            const cardPadding = 6;
            const cardWidth = pageWidth - margin * 2;
            const lineHeight = 5;

            doc.setFontSize(18);
            doc.setTextColor(31, 41, 55);
            doc.text("Franzoesisch Trainer - Report", margin, 20);
            doc.setFontSize(10);
            doc.setTextColor(107, 114, 128);
            doc.text(`Erstellt am: ${sanitizePdfText(new Date().toLocaleString())}`, margin, 28);

            let y = 36;

            gameHistory.forEach(game => {
                const topic = sanitizePdfText(game.topic);
                const date = sanitizePdfText(game.date);
                const level = sanitizePdfText(`LEVEL ${game.level}`);
                const score = sanitizePdfText(`${game.score}`);
                const percent = sanitizePdfText(`${game.percentage}%`);
                const mistakes = (game.mistakes || []).map(m => ({
                    selected: sanitizePdfText(m.selected),
                    correct: sanitizePdfText(m.correct)
                }));

                doc.setFontSize(10);
                const prefix = "Fehler: ";
                const prefixWidth = doc.getTextWidth(prefix);
                const maxX = margin + cardWidth - cardPadding;
                let xPos = margin + cardPadding + prefixWidth;
                let lineCount = mistakes.length > 0 ? 1 : 0;

                mistakes.forEach((m, idx) => {
                    const parts = [
                        { text: m.selected, isSeparator: false },
                        { text: " ", isSeparator: true },
                        { text: m.correct, isSeparator: false },
                        { text: idx < mistakes.length - 1 ? " | " : "", isSeparator: true }
                    ];
                    parts.forEach(p => {
                        if (!p.text) return;
                        const width = doc.getTextWidth(p.text);
                        if (xPos + width > maxX) {
                            lineCount += 1;
                            xPos = margin + cardPadding;
                        }
                        xPos += width;
                    });
                });

                const headerHeight = 6 + 6;
                const dividerHeight = mistakes.length > 0 ? 4 : 0;
                const mistakesHeight = mistakes.length > 0 ? lineHeight * lineCount : 0;
                const cardHeight = cardPadding * 2 + headerHeight + dividerHeight + mistakesHeight;

                if (y + cardHeight > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }

                doc.setDrawColor(229, 231, 235);
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(margin, y, cardWidth, cardHeight, 3, 3, 'FD');

                let curY = y + cardPadding + 4;
                const leftX = margin + cardPadding;

                doc.setFontSize(12);
                doc.setTextColor(17, 24, 39);
                doc.text(topic, leftX, curY);
                const topicWidth = doc.getTextWidth(topic + " ");
                doc.setFontSize(9);
                doc.setTextColor(107, 114, 128);
                doc.text(`(${date})`, leftX + topicWidth, curY);

                doc.setFontSize(12);
                doc.setTextColor(79, 70, 229);
                const scoreWidth = doc.getTextWidth(score);
                doc.text(score, margin + cardWidth - cardPadding - scoreWidth, curY);

                curY += 6;
                doc.setFontSize(9);
                doc.setTextColor(107, 114, 128);
                doc.text(level, leftX, curY);
                const percentWidth = doc.getTextWidth(percent);
                doc.text(percent, margin + cardWidth - cardPadding - percentWidth, curY);

                if (mistakes.length > 0) {
                    curY += 2;
                    doc.setDrawColor(229, 231, 235);
                    doc.line(leftX, curY, margin + cardWidth - cardPadding, curY);
                    curY += 5;

                    doc.setFontSize(10);
                    doc.setTextColor(220, 38, 38);
                    doc.text(prefix, leftX, curY);

                    let x = leftX + prefixWidth;
                    mistakes.forEach((m, idx) => {
                        const segments = [
                            { text: m.selected, color: [220, 38, 38] },
                            { text: " ", color: [220, 38, 38] },
                            { text: m.correct, color: [22, 163, 74] },
                            { text: idx < mistakes.length - 1 ? " | " : "", color: [220, 38, 38] }
                        ];
                        segments.forEach(seg => {
                            if (!seg.text) return;
                            const width = doc.getTextWidth(seg.text);
                            if (x + width > maxX) {
                                curY += lineHeight;
                                x = leftX;
                            }
                            doc.setTextColor(seg.color[0], seg.color[1], seg.color[2]);
                            doc.text(seg.text, x, curY);
                            x += width;
                        });
                    });
                }

                y += cardHeight + 6;
            });

            doc.save("franz_resultate.pdf");
        }

        // Start
        window.onload = initMenu;

    </script>
</body>
</html>
